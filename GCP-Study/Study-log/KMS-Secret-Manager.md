### [Source of this study material : Google Cloud Professional Security Engineer by Ankit Mistry](https://www.udemy.com/course/google-cloud-gcp-professional-cloud-security-engineer-certification/)


## Encryption Fundamentals

- In GCP, you store data at

  - Google Cloud Storage

  - Persistent disk, SSD (VM instance)

  - File server

  - Database file


- In case a hacker gets access to your data, you need to **encrypt** it.


- Encryption makes a plain text into some cypher text.


- To achieve it, Key1 is used to encrypt the plain text.


- In decryption, Key2 is used to decrypt the cypher text.


- In **symmetric key encryption**, Key1 and Key2 are the same.


- **Asymmetric key encryption** is where Key1 and Key2 are different.



## Cloud KMS

- Manages encryption keys on Google Cloud


- There are 3 ways of managing keys:

  - Google managed encryption keys

  - Customer managed encryption keys

  - Customer supplied encryption keys

  
### Google managed encryption keys

- By default encryption


- Server side encryption: before data is writeen to disk


- No additional configuration is required


- Google uses the algorithm **AES-256** to encrypt the data


- Google manages rotation policy


### Customer managed encryption keys

- Keys generated by Google Cloud KMS


- Customer has control over:

  - Rotation policy

  - HSM/Software based keys


- Inside KMS, you can create multiple **key rings**

  - Key ring is like a key holder

  - Key ring can hold multiple keys

  - These keys can be used for encryption purposes


### Customer supplied encryption keys

- You have complete control over encryption keys


- If key is lost, the data cannot be recovered


- To generate keys:


```
openssl rand -base64 32
```

- In this case, you cannot use cloud console to create a bucket


- You need to use **cloud shell** to create a bucket


```
gsutil -o 'GSUtil:encryption_key='keys
```


## Cloud KMS Demo

- First, go to GCS and create a bucket.


- When creating a bucket, choose **Google Managed Encryption Key**.


![gmek-bucket](/GCP_pictures/Study-logs/kms/gmek-bucket.PNG "GMEK Bucket")


- When we uploaded a file to the bucket, Google divides it into different chunks using different encryption keys. 


![upload-file](/GCP_pictures/Study-logs/kms/upload-file.PNG "Upload file")


- When we try to access the file, Google again combine those chunks back to the file and shows it to us:


![combine-file](/GCP_pictures/Study-logs/kms/combine-file.PNG "Combine file")


- Now, we are going to create a new bucket with **Customer Managed Encryption Key**. If you choose the CMEK method, then it will ask for a customer-managed key. 


![cmek-bucket](/GCP_pictures/Study-logs/kms/cmek-bucket.PNG "CMEK Bucket")


- Go to KMS and create a **key ring**.


![create-key-ring](/GCP_pictures/Study-logs/kms/create-key-ring.PNG "Create a key ring")


- Next, we need to create keys.


![key-creation](/GCP_pictures/Study-logs/kms/key-creation.PNG "Key creation")


- You can also set key rotation days. If 30 days is set, it will regenerate your key after 30 days.


![key-rotation-days](/GCP_pictures/Study-logs/kms/key-rotation-days.PNG "Key rotation days")


- Copy the key name and paste it to the Bucket.


![bucket-paste-key-name](/GCP_pictures/Study-logs/kms/bucket-paste-key-name.PNG "Paste the key name")


- If you see this message below, grant the service account to access encryption/decryption role.


![service-account-grant](/GCP_pictures/Study-logs/kms/service-account-grant.PNG "Grant service account roles")


- Upload some file to the CMEK bucket, too.


![upload-file-cmek](/GCP_pictures/Study-logs/kms/upload-file-cmek.PNG "Upload file to CMEK bucket")


- And if you try to access the object inside the CMEK bucket, you can.


![access-available](/GCP_pictures/Study-logs/kms/access-available.PNG "Access available")


- But if you disable the customer-managed key in KMS, you cannot access the file.


- Now, we are going to create **Customer Supplied Encryption Key**. As this option is only applicable to the bucket created through **cloud shell**, we are going to the cloud shell.


- Bucket creation command is:


```
gsutil mb -c regional -l us-east1 gs://[your-bucket-name]
```

- By default this bucket is using Google Managed Encryption key.


- First, go to Cloud Console and upload some file to the CSEK bucket.


![csek-bucket-upload](/GCP_pictures/Study-logs/kms/csek-bucket-upload.PNG "CSEK bucket upload")


- And then go back to the cloud shell and create a key using *openssl**:


```
openssl rand -base64 32
```


![openssl](/GCP_pictures/Study-logs/kms/openssl.PNG "Openssl random generation")


- Save this key to your notepad and create a sample file to **encrypt** with the key.


```
touch sample.txt
```

- Now, to copy the file to the destination bucket but with the **CSEK** key:


```
gsutil -o 'GSUtil:encryption_key='[openssl-generated-key] sample.txt gs://[your-bucket]
```


![copy-with-encryption](/GCP_pictures/Study-logs/kms/copy-with-encryption.PNG "Copy with CSEK encryption key")


- I have something wrong with sample.txt upload with CSEK key, so I remade the file **sample2.txt** and it worked well.


![another-copy-command](/GCP_pictures/Study-logs/kms/another-copy-command.PNG "Another copy command")


- If you go to the bucket and verify the file's encryption method, it is now customer-supplied key encrypted.


![customer-supplied](/GCP_pictures/Study-logs/kms/customer-supplied.PNG "Custoer supplied key encrypted")


- Now, let's try to read this file.


```
gstuil cat gs://yejin-csek-bucket/sample2.txt
```


- Then, we get error because we have no decryption key.


![decryption-error](/GCP_pictures/Study-logs/kms/decryption-error.PNG "Decryption error")


- But using the encryption key command, you can also decrypt the file:


```
gsutil -o 'GSUtil:encryption_key='[openssl-generated-key] cat gs://yejin-csek-bucket/sample2.txt
```


![read-file](/GCP_pictures/Study-logs/kms/read-file-success.PNG "Read file")



## Object Lifecycle Rules

- To add a lifecycle rule to your bucket, go inside your bucket and click add rule:


![add-lifecycle-rule](/GCP_pictures/Study-logs/kms/add-lifecycle-rule.PNG "Add lifecycle rule")


- First, you can select an action.


![select-action](/GCP_pictures/Study-logs/kms/select-action.PNG "Select an action")


- You can also set conditions for the object.


![set-conditions](/GCP_pictures/Study-logs/kms/set-conditions.PNG "Set conditions")


- Now, our object lifecycle rule is created.


![rule-created](/GCP_pictures/Study-logs/kms/rule-created.PNG "Rule created")



## App Secrets with Secret Manager

- While building application, we need to store:

  - Database password

  - Some API keys


- It's not a good idea to store them in the code or some config file.


- Solution is using **Secret Manager**.


- Let's see this in action. Go to the cloud console.


- Go to Secret Manager and click Create Secret.


![secret-key-value](/GCP_pictures/Study-logs/kms/secret-key-value.PNG "Secret key and value")


- So the above name is like **key** and value is **value**. It is like a **Key-value** pair.


- You can also choose **global cmek** for the encryption of the secret key.


- As we have chosen **global location** for an automatic replication policy, it is mandatory to choose global encryption key.


![global-cmek](/GCP_pictures/Study-logs/kms/global-cmek.PNG "Global cmek")


- Our secret is created. If we click three dots on the secret, we will view the secret key-value pair.


![secret-created](/GCP_pictures/Study-logs/kms/secret-created.PNG "Secret created")


- Now, to test our secret with python code, go to cloud shell.


- Then run the code in order:


```
pip3 install google-cloud-secret-manager

python3

from google.cloud import secretmanager

client = secretmanager.SecretManagerServiceClient()

name = f"projects/devops-project-yj/secrets/devops-secret/versions/latest"
response = client.access_secret_version(request={"name": name})


print(response)

payload = response.payload.data.decode("UTF-8")
print("Plaintext: {}".format(payload))
```


![response-code](/GCP_pictures/Study-logs/kms/response-code.PNG "Response code")

